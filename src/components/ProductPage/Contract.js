import React, { useEffect, useState } from "react";
import DerivAPIBasic from "https://cdn.skypack.dev/@deriv/deriv-api/dist/DerivAPIBasic";
import { useParams } from "react-router-dom";

const app_id = 1089;
const connection = new WebSocket(
  `wss://ws.binaryws.com/websockets/v3?app_id=${app_id}`
);
const api = new DerivAPIBasic({ connection });

const Contract = () => {
  const { id } = useParams();
  const [selectedContract, setSelectedContract] = useState("");
  const contracts_for_symbol_request = {
    contracts_for: id,
    currency: "USD",
    landing_company: "svg",
    product_type: "basic",
  };
  const [contracts, setContracts] = useState([]);

  const contractsForSymbolResponse = async (res) => {
    const data = JSON.parse(res.data);

    if (data.error !== undefined) {
      console.log("Error : ", data.error?.message);
      connection.removeEventListener(
        "message",
        contractsForSymbolResponse,
        false
      );
      await api.disconnect();
    }

    if (data.msg_type === "contracts_for") {
        const filteredContracts = data.contracts_for.available.filter(
            (contract) => contract.expiry_type === "tick"
          );
          setContracts(filteredContracts);
          console.log(filteredContracts);
    }

    connection.removeEventListener(
      "message",
      contractsForSymbolResponse,
      false
    );
  };

  const getContractsForSymbol = async () => {
    connection.addEventListener("message", contractsForSymbolResponse);
    await api.contractsFor(contracts_for_symbol_request);
  };

  useEffect(() => {
    getContractsForSymbol();
    const symbol_button = document.querySelector("#contractsForSymbol");
    symbol_button.addEventListener("click", getContractsForSymbol);

    return () => {
      symbol_button.removeEventListener("click", getContractsForSymbol);
    };
  }, []);

  return (
    <div>
      <button hidden
        id="contractsForSymbol"
      >
        Get contracts for symbol
      </button>
      <div id="contractsContainer">
        {contracts.length > 0 && (
          <select style={{    width: '95%',
            margin: '10px',
            borderRadius: '10px',
            size: '10px',
            height: '40px'}}
            value={selectedContract}
            onChange={(e) => setSelectedContract(e.target.value)}
          >
            <option value="">Select a contract</option>
            {Array.from(
              contracts.reduce((map, contract) => {
                const { contract_category_display } = contract;
                if (!map.has(contract_category_display)) {
                  map.set(contract_category_display, []);
                }
                map.get(contract_category_display).push(contract);
                return map;
              }, new Map())
            ).map(([category, contracts]) => (
              <optgroup label={category} key={category}>
                {contracts.map((contract, index) => (
                  <option
                    key={index}
                    value={contract.underlying_symbol}
                    title={`${contract.contract_category_display}\n${contract.contract_display}\n${contract.expiry_type}`}
                  >
                    {`${contract.contract_display} (${(contract.barrier_category).replaceAll('_','-')})`}
                  </option>
                ))}
              </optgroup>
            ))}
          </select>
        )}
      </div>
    </div>
  );
};

export default Contract;
